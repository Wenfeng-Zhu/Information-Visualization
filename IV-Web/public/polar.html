<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        body {
            width: 100vw;
            height: 100vh;
            display: flex;
        }
        #radial-bar-chart {
            margin: auto;
            position: relative;
            box-shadow: 0 0 10px 0 #eee;
        }
        .tooltip {
            position: absolute;
            left: 0;
            top: 0;
            box-shadow: 0 0 10px 0 #000000;
            width: 200px;
            height: 100px;
            border-radius: 4px;
            box-sizing: border-box;
            padding: 15px 10px;
            color: #000000;
            opacity: 0;
            background-color: #fff;
        }
        .tooltip > .province {
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div id="radial-bar-chart"></div>

    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script>


        fetch('http://localhost:3000/data/gdp')
            .then(function(response) {
                return response.json();
            })
            .then(function(myJson) {

                var data = [];
                //store state, grp and total in variant data
                for(var i in myJson){
                    data.push({
                        state: myJson[i].State,
                        GRP: myJson[i].GRPindollar,
                        //test for December incidence
                        incidence: myJson[i].sevendaysIncidence.December
                    });
                }

                //fetch another data about 7 days incidence per month and store them
                fetch('http://localhost:3000/data/incidence').then(jsonResponse => {
                    jsonResponse.json().then(responseObject =>{
                        //TODO
                        


                        const width = 500;
                        const height = 500;
                        const innerRadius = 5;
                        const outerRadius = 200;
                        // const data = getDataOfStates();
                        const chartColor = 'rgba(7, 92, 214, .7)'
                        const fontColor = '#606060'
                        const gridLineColor = 'rgb(210, 214, 218)'
                        const radiusScale = d3.scaleLinear()
                            .domain([0, d3.max(data, d => d.incidence)])
                            .range([0, outerRadius - 10])
                        
                        // 通过arc函数生成原型或圆环
                        const arc = d3.arc()
                            .innerRadius(innerRadius)
                            .outerRadius(outerRadius)
                            .padAngle(Math.PI /100)
                        const svg = d3.select('#radial-bar-chart')
                            .append('svg')
                            .attr('width', width)
                            .attr('height', height)
                            .append('g')
                            .attr('transform', `translate(${width / 2}, ${height / 2})`)
        
                        drawGrid()
                        drawChart()

                        /*svg.append('g')
                            .attr('class', 'x-axis')
                            .call(xAxis)
                        */

                        function drawChart() {
                            // set tooltip
                            const toolTip = d3.select('#radial-bar-chart')
                                .append('div')
                                .attr('class', 'tooltip')
                            toolTip.html(
                                `
                                <div class="state">
                                </div>
                                <div class="state">
                                    <span>State:</span>
                                    <span class="value"></span>
                                </div>
                                <div class="grp">
                                    <span>GRP:</span>
                                    <span class="value"></span>
                                </div>
                                <div class="incidence">
                                    <span>7 days incidence:</span>
                                    <span class="infection"></span>
                                </div>
                                `
                            )

                            // 饼图数据
                            const pieData = d3.pie().value(d => d.GRP)(data)
                            const arcs = svg
                               .append('g')
                                .attr('class', 'arcs')
                                .selectAll('g')
                                .data(pieData)
                                .enter()
                               .append('path')
                                .attr('class', 'arc')
                                .attr('fill', chartColor)
                                .attr('d', function (d) {
                                    // 动态设定外半径
                                    arc.outerRadius(radiusScale(d.data.incidence))
                                    // 注册path data
                                   return arc(d)
                                })
                                .on('mouseover', function (d, i) {
                                    d3.select(this).transition()
                                        .duration('50')
                                        .attr('opacity', '.85')

                                    toolTip.style('opacity', 1)
                                    toolTip.style('left', d3.event.pageX)
                                    toolTip.style('top', d3.event.pageY)
                                    toolTip.select('.state .value').text(d.data.state)
                                    toolTip.select('.grp .value').text(d.data.GRP + '€')
                                    toolTip.select('.incidence .infection').text(d.data.incidence)
                                })
                                .on('mouseout', function (d, i) {
                                    d3.select(this).transition()
                                        .duration('50')
                                        .attr('opacity', '1');
                                    toolTip.style('opacity', 0)
                            })
                        }

                        function xAxis(g) {
                            // 计算x轴标签位置
                            const xLabel = d3.scaleBand()
                                .domain(data.map(d => d.state))
                                .range([0, 2 * Math.PI])
                            g.attr('class', 'x-axis')
                                .attr('text-anchor', 'start')
                                .attr('dominant-baseline', 'middle')
                                .attr('stroke', fontColor)
                                .attr('stroke-width', 1)
                                .style('font-size', 14)
                                .style('font-weight', 100)
                                .call(g => {
                                    g.selectAll('g')
                                    .data(data)
                                    .enter()
                                    .append('g')
                                    .attr('transform', d => {
                                        const rotateAngle = tsRadian2angle(xLabel(d.state) + xLabel.bandwidth() / 2) - 90
                                            return `
                                                rotate(${ (rotateAngle) })
                                                translate(${ outerRadius + 5}, 0)
                                            `
                                    })
                                    .call(g => {
                                        g.append('line')
                                            .attr('x2', -5)
                                        g.append('text')
                                            .text(d => d.state)
                                            .attr('transform', function (d, i) {
                                                // 通过getBBox访问到text元素的长度
                                                const val = tsRadian2angle(xLabel(d.state) + xLabel.bandwidth() / 2) > 180
                                                    ? `rotate(180) translate(${ -this.getBBox().width - 10 }, 0)`
                                                    : 'translate(10, 0)'
                                                return val
                                            })
                                    })
                                })
                        }
            
                        // 绘制背景网格
                        function drawGrid() {
                            const gridWrapper = svg.append('g')
                                .attr('class', 'grid-wrapper')
                                .attr('fill', 'transparent')
                                .attr('stroke', gridLineColor)
                                .attr('stroke-width', 1)
                                .attr('stroke-dasharray', '5,5')
                                .attr('text-anchor', 'end')
                                .attr('dominant-baseline', 'middle')
                                .style('font-size', 12)
                                .style('font-weight', 100)
                            const maxTotal = d3.max(data, d => d.incidence) * outerRadius / ( outerRadius - 10 )
                            for (let i = 1; i <= 6; i++) {
                                const n = maxTotal / 6 * i >>> 0
                                gridWrapper.append('circle')
                                    .attr('r', outerRadius / 6 * i)
                                gridWrapper.append('text')
                                    .text(n)
                                    .attr('transform', `translate(0, ${ -outerRadius / 6 * i })`)
                            }
                            const bandWidth = 2 * Math.PI / data.length
                            for (let i = 0; i < data.length; i++) {
                                const x = outerRadius * Math.sin( bandWidth * i + bandWidth / 10)
                                const y = outerRadius * Math.cos( bandWidth * i + bandWidth / 10)
                                gridWrapper.append('line')
                                    .attr('x2',  x)
                                    .attr('y2',  y)
                            }
                        }
            
                        // transform radian to angle
                        function tsRadian2angle(radian) {
                            return radian * 180 / Math.PI
                        }           
                    });
                });
            });
        
    </script>
</body>
</html>